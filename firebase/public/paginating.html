<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="robots" content="noindex, nofollow">
  <meta name="googlebot" content="noindex, nofollow">
  <script type="text/javascript" src="//code.jquery.com/jquery-2.0.2.js"></script>
  <link rel="stylesheet" type="text/css" href="/css/result-light.css">
  <script type="text/javascript" src="http://static.firebase.com/v0/firebase.js"></script>
  <style type="text/css">
    div {
    padding: 20px;
    font-size: 20px;
    border-radius: 15px;
    background-color: #fafafa;
    border: 1px solid #999;
    font-family:'Courier New', 'Courier', monospaced;
    margin-bottom: 10px;
    }
    h3 {
    clear: both;
    padding-top: 20px;
    }
    button {
    font-size: 36px;
    }

  </style>

  <title>A Simple Paginator</title>


<script type="text/javascript">//<![CDATA[
$(window).load(function(){
/***************************
  A SIMPLE PAGINATOR
  *************************/
function Paginator(ref, limit) {
    this.ref = ref;
    this.pageNumber = 0;
    this.limit = limit;
    this.lastPageNumber = null;
    this.currentSet = {};
}

Paginator.prototype = {
    nextPage: function (callback) {
        if( this.isLastPage() ) {
            callback(this.currentSet);    
        }
        else {
            var lastKey = getLastKey(this.currentSet);
            // if there is no last key, we need to use undefined as priority
            var pri = lastKey ? null : undefined;
            this.ref.startAt(pri, lastKey)
                .limit(this.limit + (lastKey? 1 : 0))
                .once('value', this._process.bind(this, {
                    cb: callback,
                    dir: 'next',
                    key: lastKey
                }));
        }
    },

    prevPage: function (callback) {
        console.log('prevPage', this.isFirstPage(), this.pageNumber);
        if( this.isFirstPage() ) {
            callback(this.currentSet);    
        }
        else {
            var firstKey = getFirstKey(this.currentSet);
            // if there is no last key, we need to use undefined as priority
            this.ref.endAt(null, firstKey)
                .limit(this.limit+1)
                .once('value', this._process.bind(this, {
                    cb: callback,
                    dir: 'prev',
                    key: firstKey
                }));
        }
    },

    isFirstPage: function () {
        return this.pageNumber === 1;
    },

    isLastPage: function () {
        return this.pageNumber === this.lastPageNumber;
    },

    _process: function (opts, snap) {
        var vals = snap.val(), len = size(vals);
        console.log('_process', opts, len, this.pageNumber, vals);
        if( len < this.limit ) {
            // if the next page returned some results, it becomes the last page
            // otherwise this one is
            this.lastPageNumber = this.pageNumber + (len > 0? 1 : 0);   
        }
        if (len === 0) {
            // we don't know if this is the last page until
            // we try to fetch the next, so if the next is empty
            // then do not advance
            opts.cb(this.currentSet);
        }
        else {
            if (opts.dir === 'next') {
                this.pageNumber++;
                if (opts.key) {
                    dropFirst(vals);
                }
            } else {
                this.pageNumber--;
                if (opts.key) {
                    dropLast(vals);
                }
            }
            this.currentSet = vals;
            opts.cb(vals);
        }

    }
};

/***************************
  APPLICATION LOGIC
  *************************/
var fb = new Firebase('https://teglas-d9872.firebaseio.com/posts');
var paginator = new Paginator(fb, 5);
moveForward();

$('#prev').click(moveBackward);
$('#next').click(moveForward);


/***************************
  DEMO UTILS (fluff)
  *************************/

function moveForward() {
    loading();
    paginator.nextPage(loaded);
}

function moveBackward() {
    loading();
    paginator.prevPage(loaded);
}

function loading() {
    $('button').prop('disabled', true);
}

function loaded(vals) {
    console.log('loaded', vals);
    var messages = map(vals, function (v, k) {
        return v.color + ' ' + v.shape + '<br />';
    });
    $('#prev').prop('disabled', paginator.isFirstPage());
    $('#next').prop('disabled', paginator.isLastPage());
    $('div').html(messages.length ? messages.join("\n") : '-no records-');
}

function getLastKey(obj) {
    var key;
    if (obj) {
        each(obj, function (v, k) {
            key = k;
        });
    }
    return key;
}

function getFirstKey(obj) {
    var key;
    if (obj) {
        each(obj, function (v, k) {
            key = k;
            return true;
        });
    }
    return key;
}

function dropFirst(obj) {
    if (obj) {
        delete obj[getFirstKey(obj)];
    }
    return obj;
}

function dropLast(obj) {
    if (obj) {
        delete obj[getLastKey(obj)];
    }
    return obj;
}

function map(obj, cb) {
    var out = [];
    each(obj, function (v, k) {
        out.push(cb(v, k));
    });
    return out;
}

function each(obj, cb) {
    if (obj) {
        for (k in obj) {
            if (obj.hasOwnProperty(k)) {
                var res = cb(obj[k], k);
                if (res === true) {
                    break;
                }
            }
        }
    }
}

function size(obj) {
    var i = 0;
    each(obj, function () {
        i++;
    });
    return i;
}
});//]]> 

</script>

  
<style type="text/css">/* This is not a zero-length file! */</style><style type="text/css">/* This is not a zero-length file! */</style></head>

<body>
  <h3>A Simple Paginator</h3>

<div>undefined undefined<br>
undefined undefined<br>
undefined undefined<br>
undefined undefined<br>
undefined undefined<br>
undefined undefined<br></div>
<button id="prev">prev 5</button>
<button id="next">next 5</button>
  
  <script>
  // tell the embed parent frame the height of the content
  if (window.parent && window.parent.parent){
    window.parent.parent.postMessage(["resultsFrame", {
      height: document.body.getBoundingClientRect().height,
      slug: "None"
    }], "*")
  }
</script>





</body></html>